<script>
    let currentMode = 'global';

    // 1. FORCED ENGINE REGISTRATION
    async function registerSW() {
        if ('serviceWorker' in navigator) {
            try {
                // We use the absolute path to ensure the worker finds the config
                await navigator.serviceWorker.register('./uv.sw.js', {
                    scope: __uv$config.prefix
                });
                console.log("Shadow DRS: Engine Synchronized");
            } catch (err) {
                console.error("Shadow DRS: Registration failed", err);
            }
        }
    }

    // Call on load
    registerSW();

    function toggleSettings() {
        const p = document.getElementById('settings-panel').style;
        p.display = p.display === 'block' ? 'none' : 'block';
    }

    function saveSettings() {
        document.title = document.getElementById('set-title').value;
        toggleSettings();
    }

    function openSearch(m) {
        currentMode = m;
        const icon = document.getElementById('mode-icon');
        const text = document.getElementById('mode-text');
        
        if(m === 'global') {
            icon.src = "https://i.ibb.co/rRHfMTH6/Shadow-DRS-icon-1.png";
            text.innerText = "Shadow Global (Google)";
        } else {
            icon.src = "https://i.ibb.co/VW0TsZvf/Shadow-DRS-logo.png";
            text.innerText = "Shadow DRS (DuckDuckGo)";
        }
        
        document.getElementById('search-box').style.display = 'flex';
        document.getElementById('user-input').focus();
    }

    function closeSearch() { document.getElementById('search-box').style.display = 'none'; }

    async function launch() {
        const val = document.getElementById('user-input').value;
        if (!val) return;

        let url = val.trim();
        // Check if it's a URL or a search query
        if (!url.includes('.') || url.includes(' ')) {
            // Use DuckDuckGo if Google throws 500 errors
            let engine = (currentMode === 'drs') ? 'https://duckduckgo.com/?q=' : 'https://www.google.com/search?q=';
            url = engine + encodeURIComponent(url);
        } else if (!url.startsWith('http')) {
            url = 'https://' + url;
        }

        // REGISTER AGAIN RIGHT BEFORE LAUNCH TO BE SAFE
        await registerSW();

        try {
            const encodedUrl = __uv$config.prefix + __uv$config.encodeUrl(url);
            
            document.getElementById('home').style.display = 'none';
            document.getElementById('search-box').style.display = 'none';
            
            const frame = document.getElementById('engine-ifr');
            frame.style.display = 'block';
            frame.src = encodedUrl;
        } catch (e) {
            alert("Encoding Error: Try clearing your browser cache.");
        }
    }

    window.addEventListener('keydown', (e) => {
        const pKey = document.getElementById('set-key').value || '`';
        if(e.key === pKey) {
            document.getElementById('panic-screen').style.display = 'block';
            window.location.href = document.getElementById('set-purl').value || "https://clever.com/";
        }
    });

    document.getElementById('user-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') launch();
    });
</script>
